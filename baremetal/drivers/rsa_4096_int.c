//modexp_4096_0x10001.dat
//#include "clib.h"
#include "rsa.h"
#include "misc.h"
#include "ck810.h"
#include "intc.h"


volatile int intr_flag=1;
volatile int intr_num=0;
static CK_UINT8  case_fail = 0;

CKStruct_IRQHandler rsa_irqhandler;

void RSA_IntrHandler(){
    int tmp;
   
    printf(" RSA isr ..... \n");

    if(intr_num == 0){
     // Check expected status: stop reason should be 0 (Normal)!  
      tmp = read_mreg32(RTN_CODE);
      if((tmp&0x40ff0000) != 0x40000000){
           case_fail = 1;
      } 

      tmp = read_mreg32(STACK_PNTR);
      if((tmp&0x0000000f) != 0x0){
           case_fail = 1;
      } 

      printf("Clear int!\n");

      write_mreg32(STAT, 0x40000000);
      tmp = read_mreg32(RTN_CODE);
      if((tmp&0x40ff0000) != 0x0){
           case_fail = 1;
      } 


    }
    else if(intr_num == 1){
       

    }


      intr_flag=0;
      intr_num = intr_num+1;

}



int PKA_A0[] = {
0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x74A8C134,0x806B14B0,0x66E45962,0x2DD30AB4,0x38C6BD8A,0x229B0A37,0xC8A45FC2,0x35C9150F,0x9E5A9180,0xC2C5E3E8,0xCC155AE8,0xAEC931C7,0xD73147AC,0x399428B3,0xA8936C1C,0xADFF43F8,0x3F158C1E,0x3078B172,0x79779945,0x1896F781,0x8BE545C0,0xD84AB220,0xC7C43564,0x7342A951,0xD24C2305,0x74A4E3E3,0x2E644D04,0x72D109DB,0x0933ECA9,0xBD562792,0x02FE45EC,0x49B21814,0x55375F8A,0xD61328EE,0xA9D3B8EF,0xF3728828,0x7CCAF461,0x05112A9A,0x25584F77,0xBD39EE56,0x18E3D4DC,0xC19CBA56,0xEBBFE6C9,0x4B5C0C4F,0x8B0ACB55,0x060D8C75,0x823E6AD4,0xBDBD8383,0x2D214474,0xB5A0616A,0x8A94B258,0xCC6E21CE,0xBFAFCDB6,0xE3844B4F,0x08B5D51D,0xCE1BBE7F,0xABBA4BA9,0x39C8FDA1,0x2A6FCA4C,0x2C512E1A,0x079D4F23,0xFE73C29B,0x2B7DB4A9,0xF1621828,0xB8E9BB66,0xD3A53CDF,0x3AC92677,0xFB9B4C46,0xF5468FC9,0xF0358FA1,0xB517D892,0x95594B47,0x62548F67,0x4CBDD3A6,0x4A06F1D5,0x833D57DF,0x78DED51E,0xD6CABD0B,0x39B290EF,0xE82F6D41,0xE11F8A56,0x790E68F5,0xF51E5E1B,0x1C81F82C,0x33F64ED5,0xA64F731C,0xF977EFC6,0xC92DA8C5,0xEBBF8D61,0x353643C5,0xE81388D1,0x767F915E
};

int PKA_D0[] = {
0xD1BB5E81,0xD2152900,0x24D573A2,0x417F9C9E,0x7688E3BC,0xDACE5846,0x804774C4,0x6F222FD9,0xB56CC4B4,0xEE9A5BF8,0x8049798E,0x15F7EF7A,0xA41B10D9,0xFAD12DAA,0xD556A7CF,0xAD4DFAA2,0xCE2FF29F,0xA311DE6C,0x20793DD1,0x05EB25FB,0x69410FFD,0xD40F97A2,0x3F37FA15,0x146CF363,0xD516F39B,0xE452166F,0xBE41BC91,0xC841BA05,0x5B4F3DBD,0xF35BAC9D,0xEA5A2E42,0xE0D4D348,0xBA472520,0xF5FF2FD8,0xC72EAECD,0x5D999730,0xF488AE50,0xAF3EAD48,0xD52C91E0,0x166B4EDA,0x360FF36D,0x5CA98898,0x0CB85A29,0x0850418A,0x2E0F6A6C,0x0DF5C37D,0xC626E96B,0x083BC413,0x417CC1B9,0xA37E6D52,0xDCB47BA9,0xD1A4C672,0x0F07EDB3,0x1A3BFFEA,0x74C2F898,0x0F24D063,0x8314630A,0x038ADD8C,0x36F94C44,0xCD4FE146,0x57DC2A94,0x0FD1C153,0x3C8D3E14,0x14511B22,0x793E6E18,0x3E1CB0EC,0xEA9E9B5D,0xDDD453D8,0xD01B8459,0xD6B5CCE3,0x836CE40E,0xAE403C42,0xFDAEF706,0xC0707260,0xD8DDD3F5,0xE1442FDE,0xDC037BE8,0x255626B4,0x5BC0E930,0xDB9D906F,0x0FA6ED2D,0x979A6184,0x87926E61,0x1A91E585,0x4D25FCD9,0x4E3D5BD9,0xE6E5A343,0xE1A26FA0,0x1A59FC22,0x54980FC5,0x3CC50726,0x36F98C55,0xDE0D8064,0xAF7A3A23,0x93C06321,0xBF1C3F72,0xE1251654,0xEFEA9B7C,0xC85DF123,0x9B94672D,0x648B3E5E,0x4A29561A,0x7CD3801B,0xE6844102,0xBF9F7939,0x33E339A8,0x5603D218,0x3C858E63,0xC9410E4B,0xEE658DD0,0x6A426346,0xA4D59B41,0x5B058268,0xE4102143,0x872FE203,0xC954D293,0x8908CEC6,0x762F8BA2,0x4A82398C,0xA368DC14,0xF06FF9A0,0xC413C4F3,0xB2A3CF45,0x50E33E85,0x69A2957B,0x3D752E7E,0x7CE848AE,0x1DB9E2BF
};

int PKA_D1[] = {
0x3D192BBF,0xC7C545CC,0x5BB0AD7B,0x0E89A0FC,0xC42222CA,0x59DA6021,0x8F1DA3A9,0x4E52099D,0x40C28416,0x122D9009,0xD506FBC6,0x140F3BB8,0xA915AAD8,0xAE76B426,0xD448DEE2,0xE1355A6E,0x9FA4B4A7,0x5B874EEB,0x2366FEBA,0x12C8F435,0xB047CCEE,0xCF444596,0xCFB075CF,0x3201850F,0xF36A1DF0,0x8848B8A4,0xB3C634D8,0x94FB7F37,0x5E5B1BC4,0x3EEDFC3D,0xA764D335,0x738CF049,0x5FA1A190,0x944F6E71,0xBB2ACF4A,0x010C2C86,0xBEF63EF5,0x332E6736,0xFF359194,0x44865848,0xECA992A9,0x74DC8C48,0xA83CF647,0x91B9F6DE,0x1D9948BB,0xF0961AA7,0x866A5503,0x599C6681,0x53908C52,0xED8BDBB7,0xCDBC8092,0x87B11427,0xC1B2A984,0x518DB0A5,0x844BDF1B,0x799FAA4C,0xBABA1010,0x575C9982,0x4719C255,0x26B15D7F,0x01E1B84D,0x2936755F,0xC924D00D,0x21A3AD77,0x7F5033F9,0x94B8F7DD,0x8B973399,0xF060CB70,0x022E01F9,0x65499B74,0x7F701ADF,0x3A4DEEA2,0xA9FE8457,0x6826AF18,0x202F3D76,0xEFDF3D06,0x0D7AAADB,0x51BB1ADC,0xCD1031BC,0xEC06A92E,0xA1CDC469,0xDFEE9CB2,0xD282BE90,0xD2EEC0A3,0xCD8E9C3F,0x965656C1,0x42E15322,0xA0045503,0xF65F4429,0xDD220B86,0x5515304E,0xB678A70B,0xFCE57396,0x60709838,0xC1B9DE06,0xF5BB6420,0x8BF5A16A,0x2947A244,0xA206D93F,0x132D2B3F,0x3A560EA1,0x012A1F07,0x15865961,0x08A2127E,0x24CDECEC,0xD0E72BE2,0x75518FB9,0x08A51FA1,0x44127B13,0x585ED541,0x085CB273,0x0BBA40C1,0x72CB3CD0,0xDE3AD8F0,0x7D9B08F1,0xD7655FC3,0x48EE9110,0xB061389A,0x6889C5A6,0x8A854958,0x4B561D83,0xB0EE3863,0xD657637E,0x89DE520B,0x7273FD3E,0x74950735,0x228818DB,0x2FDD72C1
};

int PKA_D2[] = {
0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00010001
};

int PKA_D3[] = {
0x01F61623,0x6C391AD0,0x8F0D1204,0x5D9D6DD4,0xFA31DDD1,0x8C33E58F,0x5E87CD49,0xD4A1B4CE,0xA72679E7,0x729F0DE4,0xEDDD7E07,0x94725046,0xBE1DBCED,0x53A90CBE,0x5D4A5EC8,0x347172F1,0x71C1F1ED,0xA1C542A4,0x25733F7F,0x1FF7825C,0xB3E760ED,0x8229B780,0xDE2487AF,0x9E67BA7E,0x3D2B16EE,0xFB60218F,0x4FB5ACB6,0x394A0F2A,0x3B497759,0x7CD2D490,0x4A9735D1,0x375DFB97,0xA56ACF50,0x372030D8,0x2ECE6984,0xCFE611A8,0xC421149A,0xDA079B48,0x0783F2F5,0xDBE4EECA,0xB67A7986,0xC686A784,0x9B74FDC1,0xC666B899,0xF521D85E,0x29FC9374,0x37F0F316,0xB6C7E3B3,0x4E595A1E,0x7C3A0420,0x20CF3E0E,0x4517F90A,0x5B05A1EA,0x02E07F77,0x282C805D,0x284F1408,0xF83EB81E,0x222755A5,0xDDBF9D46,0x4612E011,0x44CADD1D,0xE47C16E0,0x7412874C,0x2BBC2FCC,0x9564D8F8,0xA7089E07,0x70A1CD67,0xFB1EB374,0xBD76C562,0x6F22A795,0xB21B0461,0xD9B9A52A,0x59277DAD,0x44AADCC8,0x7BC4F248,0x74F72AFF,0xB3B1931A,0x0569E34D,0xC198F27A,0x4BDB774D,0x16807774,0x2014AC23,0xE6D8F571,0x75E3C46A,0x6EAF1181,0xB2A26747,0x974EBC78,0x47385833,0x8CC5978F,0x0F9AE6E7,0x581CD333,0x24AF42A7,0xB4509AEF,0x0256694C,0x6DE70929,0xF3A54EF3,0xC886726A,0x1751CB47,0x04F57600,0xF7F7B8E7,0xC937AD39,0xB3919526,0xD6284F53,0x6C44779C,0xB608C879,0xFA7AADFE,0xCF0D004E,0x0C0AB808,0xC9AC3872,0x22F369F0,0x3209ADE4,0x8C447DFA,0x617CDDE6,0x2C222D62,0xED1D3793,0x15992DB6,0x872B8446,0xA2973474,0x817815EF,0x4AB7D384,0xBCA3E1F2,0x462C9BBB,0xC8B018A4,0xEAB8FBEC,0xA268C09D,0xF1481520,0xA62D13AB,0xB12905D2
};


int PKA_A0_CHK[] = {
0x11E66601,0x27E3DC49,0xE0C1CC0B,0xD2097CCF,0x199A49CA,0x03A1B2D0,0xE0B325A0,0xC7E0F625,0x4796F91A,0xF84DF07D,0x1EFFB729,0x86923F25,0x4AD944C2,0xA54489D2,0x733E5F78,0x9BBDC687,0x7F9521C8,0xC125668A,0xA624F994,0x8A94ECD4,0x18FB5F12,0x11309F2F,0xB115A15E,0xB9D5C008,0x87CFADDF,0x574871A1,0xD67CBFEE,0x5C01C063,0x9901E16D,0xB54BF478,0x479372BE,0xF5C2DC6F,0x50F9590B,0xF3233BF1,0x59F916FD,0x31B332AD,0x320B557F,0xFC2B655C,0x3AB6D34D,0x503B3CEB,0x52E9F7F3,0xBB1D8B39,0xE9FFB303,0xED454515,0x2D0E60F4,0xAFDF0673,0x4EFC91B7,0x68C70657,0xB6D28DAD,0xE2252637,0xE514970F,0xE5DDFC40,0x077500E4,0xC3029A37,0x833B1E68,0xE367467F,0x2C01DED0,0x0B6D48C3,0x64306E41,0x57D9CCB9,0x744BEB66,0xB2E725FE,0x136431AF,0x37296C09,0x64F98343,0x8202B614,0x72CF0C65,0x1C59DB75,0x9AE8AEB4,0xAADDBEDD,0xE7E44594,0xE140D2EB,0x3B7A0BCE,0xFACE3740,0xA7D64320,0x4DF53548,0x295C8D37,0x2546C20C,0x42C4FB0F,0x222641F2,0xFC9FE5A3,0xDEAAD19B,0x3468DB2C,0x832F6215,0x0ADD066E,0x9627D0E1,0x0F122893,0x0D8B10B8,0x5C316FAB,0xAB164B22,0xC7F8F49F,0xFB2AF5B5,0xACBEDCCD,0xDB4067BF,0xFD895CEB,0x0C04BD8E,0x192199F1,0x3FE4B122,0xBF85021B,0xB9494BE5,0x8291EC97,0x4EB3FDBB,0x1597B5DD,0x4980DCE5,0x6C7CE162,0xDC87553E,0xA3B7D263,0x6E7D93A7,0xC2EC26EC,0x375763F3,0x1EBB1A9B,0x7A6349F3,0xAB72F9F1,0xB283E4EA,0x050C687B,0x5924635C,0x0A5A1E38,0x95C54289,0x92A898BE,0x82B0CCD1,0x65891D6E,0xDBD43169,0xE2C14B04,0x2AF27994,0xDDD58DBC,0xB7E743E8,0x7A004C87,0x00A614DF
};




int CK_RSA_Test (void)
{
    int result;
    int tmp;
    int k;
    int i;

///////////////////////////////////////////////////////////////

    printf("Intr test start!\n");

    memset(&rsa_irqhandler,0,sizeof(PCKStruct_IRQHandler));
    //rsa int handle
    rsa_irqhandler.devname = "rsa";//IP name 
    rsa_irqhandler.irqid = CK_INTC_RSA;//defined in  "rte/ck810/inc/interrupt.h"
    rsa_irqhandler.priority = CK_INTC_RSA;  //  lowest:0 ~ highest:63  
    rsa_irqhandler.handler = RSA_IntrHandler; //Your interrupt service routine 
    rsa_irqhandler.bfast = FALSE;  // FALSE:Normal TURE:Fast
    rsa_irqhandler.next = NULL;    //FASLE:can not be nested
    CK_INTC_RequestIrq(&rsa_irqhandler, AUTO_MODE);

    case_fail = 0;
    printf("# Wr A0 #\n");

    for(i=0;i<128;i=i+1){
        write_mreg32(PKA_REGION_A+0x4*i, PKA_A0[127-i]);

    }

    printf("# Wr D0 #\n");

    for(i=0;i<128;i=i+1){
        write_mreg32(PKA_REGION_D+0x4*i, PKA_D0[127-i]);

    }

    printf("# Wr D1 #\n");

    for(i=0;i<128;i=i+1){
        write_mreg32(PKA_REGION_D+0x200+0x4*i, PKA_D1[127-i]);

    }

    printf("# Wr D2 #\n");

    for(i=0;i<128;i=i+1){
        write_mreg32(PKA_REGION_D+0x400+0x4*i, PKA_D2[127-i]);

    }

    printf("# Wr D3 #\n");

    for(i=0;i<128;i=i+1){
        write_mreg32(PKA_REGION_D+0x600+0x4*i, PKA_D3[127-i]);

    }


    //Write Flag
    write_mreg32(FLAGS, 0x0);

    // Entry point -- Set to modexp = 16
    write_mreg32(ENTRY_PNT, 0x16);

    // Setup Dial-a-DTA (probabilistic jump comparison register) for 0%
    write_mreg32(JMP_PROB, 0x0);

    // Enable IRQ level
    write_mreg32(IRQ_EN, 0x40000000);

    // Start CLUE operation
    // Op-size: 6 (4096-bits)
    // Partial: 0 (4096-bits)
    write_mreg32(CTRL, 0x80000600);

    //Wait for interrupt
    while(intr_flag != 0);
    //interrupt
    intr_flag = 1;

    printf("# Check data #\n");

    for(i=0;i<128;i=i+1){
        tmp = read_mreg32(PKA_REGION_A+i*0x4);
        k = 127-i;
        result = PKA_A0_CHK[k];

        if(tmp != result){
           printf("Addr 0x%x value 0x%x != 0x%x\n", PKA_REGION_A+i*0x4, tmp, result);
           case_fail = 1;
        } 

    }




////////////////////////////////////////////////////////
    if (case_fail)
        printf("case is failed! \n");
    else
        printf("case is passed! \n");

//case_pass;

}
